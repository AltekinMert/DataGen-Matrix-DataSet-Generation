from dynamic_matrix_expansion import load_matrix, expand_matrix, display_matrices
from scipy.sparse import csr_matrix
import scipy.io
import numpy as np
import os
from compute_loss import compute_matrix_properties, compute_property_loss, perturb_matrix, weights

def get_desired_informations():
    """Get desired information from the user."""
    try:
        rows = int(input("Enter desired number of rows: "))
        cols = int(input("Enter desired number of columns: "))
        additional_density = int(input("Enter desired additional density: "))
        num_matrices = int(input("Enter the number of matrices you want to generate: "))
        return rows, cols, additional_density, num_matrices
    except ValueError:
        print("Invalid input. Please enter integers.")
        return None, None, None, None
    
def generate_multiple_matrices(original_matrix, desired_rows, desired_cols, desired_density, desired_num):
    original_props = compute_matrix_properties(original_matrix)

    loss_values = []
    generated_matrices = []

    for i in range(desired_num):
        print(f"Generating matrix {i+1}/{desired_num}...")
        
        # Expand the matrix
        expanded_matrix = expand_matrix(original_matrix, desired_rows, desired_cols, desired_density)
        generated_matrices.append(expanded_matrix)

        # Compute the newly created matrix properties
        new_props = compute_matrix_properties(expanded_matrix)

        # Compute property-based loss
        loss_val = compute_property_loss(original_props, new_props, weights)
        loss_values.append(loss_val)

        print(f"Loss for matrix {i+1} = {loss_val:.1f}")
        
        # Save the generated matrices in .mtx format
        save_path = f"{output_directory}/expanded_matrix_{i+1}.mtx"
        scipy.io.mmwrite(save_path, csr_matrix(expanded_matrix))
        
        print(f"Matrix {i+1} saved to {save_path}")

    # Summarize best matrix
    best_idx = np.argmin(loss_values)
    print(f"\nBest matrix is matrix {best_idx+1} with loss = {loss_values[best_idx]:.1f}")
    print(f"All {desired_num} matrices have been generated.")

    return generated_matrices, loss_values

def optimize_multiple_matrices(original_matrix,
                               init_matrices,  # list of generated matrices
                               weights,
                               max_iters=50):
    """
    Minimizes the sum of property-based losses for all matrices simultaneously.
    local_search style / coordinate descent approach.
    
    :param original_matrix: the reference matrix
    :param init_matrices: list of 10 numpy arrays (expanded matrices)
    :param weights: dictionary of property weights
    :param max_iters: number of local search iterations
    :return: a list of optimized matrices (10 of them)
    """
    import copy
    import numpy as np
    
    # Copy the initial solutions
    matrices = [copy.deepcopy(mat) for mat in init_matrices]
    # matrices = init_matrices
    
    # Precompute original properties once
    orig_props = compute_matrix_properties(original_matrix)
    
    # Helper to compute the total cost
    def total_loss(matrices_list):
        loss_sum = 0.0
        for mat in matrices_list:
            mat_props = compute_matrix_properties(mat)
            loss_sum += compute_property_loss(orig_props, mat_props, weights)
        return loss_sum
    
    current_loss = total_loss(matrices)
    
    for iteration in range(max_iters):
        # pick one matrix index at random
        k = np.random.randint(len(matrices))
        
        # small perturbation to the chosen matrix
        old_matrix = copy.deepcopy(matrices[k])
        old_loss = current_loss
        
        # Change matrix proeprties hoping that it reduces loss
        matrices[k] = perturb_matrix(matrices[k])
        
        # compute new total loss
        new_loss = total_loss(matrices)
        
        if new_loss > old_loss:
            # revert if no improvement
            matrices[k] = old_matrix
        else:
            current_loss = new_loss
        
# if (iteration+1) % 500 == 0:
        print(f"Iter {iteration+1}, current loss = {current_loss:.1f}")
    
    return matrices


# File paths
file_path = "original-matrices/685_bus.mtx"
output_directory = "generated-matrices"

# Ensure the output directory exists
os.makedirs(output_directory, exist_ok=True)

# Load the original matrix
original_matrix = load_matrix(file_path)

if original_matrix is not None:
    print("Original matrix loaded successfully.")
    print("Shape of original matrix:", original_matrix.shape)
    
    # Get user inputs
    desired_rows, desired_cols, desired_density, num_matrices = get_desired_informations()
    
    if all(v is not None for v in [desired_rows, desired_cols, desired_density, num_matrices]):
        print(f"Desired dimensions: {desired_rows}x{desired_cols}, Density: {desired_density}, Matrices: {num_matrices}")
        
        # Generate the matrices
        generated_matrices, loss_values = generate_multiple_matrices(original_matrix, desired_rows, desired_cols, desired_density, num_matrices)

        print("Optimizing generated matrices properties ...")

        # Optimize matrices
        optimized_matrices = optimize_multiple_matrices(original_matrix, generated_matrices, weights, max_iters=5000)

    else:
        print("Failed to get valid dimensions or inputs.")
else:
    print("Failed to load the matrix.")

"""
Iter 120, current loss = 414832.4
Iter 121, current loss = 414832.4
Iter 122, current loss = 414832.4
Iter 123, current loss = 414832.4
Iter 124, current loss = 414832.4
Iter 125, current loss = 414832.4
Iter 126, current loss = 414832.4
Iter 127, current loss = 414832.4
Iter 128, current loss = 414832.4
Iter 129, current loss = 414832.4
Iter 130, current loss = 414832.4
Iter 131, current loss = 414832.4
Iter 132, current loss = 414832.4
Iter 133, current loss = 414832.4
Iter 134, current loss = 414832.4
Iter 135, current loss = 414832.4
Iter 136, current loss = 414832.4
Iter 137, current loss = 414832.4
Iter 138, current loss = 414832.4
Iter 139, current loss = 414832.4
Iter 140, current loss = 414832.4
Iter 141, current loss = 414832.4
Iter 142, current loss = 414832.4
Iter 143, current loss = 414832.4
Iter 144, current loss = 414832.4
Iter 145, current loss = 414832.4
Iter 146, current loss = 414832.4
Iter 147, current loss = 414832.4
Iter 148, current loss = 414832.4
Iter 149, current loss = 414832.4
Iter 150, current loss = 414832.4
Iter 151, current loss = 414832.4
Iter 152, current loss = 414832.4
Iter 153, current loss = 414832.4
Iter 154, current loss = 414832.4
Iter 155, current loss = 414832.4
Iter 156, current loss = 414832.4
Iter 157, current loss = 414832.4
Iter 158, current loss = 414832.4
Iter 159, current loss = 414832.4
Iter 160, current loss = 414832.4
Iter 161, current loss = 414832.4
Iter 162, current loss = 414832.4
Iter 163, current loss = 414832.4
Iter 164, current loss = 414832.4
Iter 165, current loss = 414832.4
Iter 166, current loss = 414832.4
Iter 167, current loss = 414832.4
Iter 168, current loss = 414832.4
Iter 169, current loss = 414832.4
Iter 170, current loss = 414832.4
Iter 171, current loss = 414832.4
Iter 172, current loss = 414832.4
Iter 173, current loss = 414832.4
Iter 174, current loss = 414832.4
Iter 175, current loss = 414832.4
Iter 176, current loss = 414832.4
Iter 177, current loss = 414832.4
Iter 178, current loss = 414832.4
Iter 179, current loss = 414832.4
Iter 180, current loss = 414832.4
Iter 181, current loss = 414832.4
Iter 182, current loss = 414832.4
Iter 183, current loss = 414832.4
Iter 184, current loss = 414832.4
Iter 185, current loss = 414832.4
Iter 186, current loss = 414832.4
Iter 187, current loss = 414832.4
Iter 188, current loss = 414832.4
Iter 189, current loss = 414832.4
Iter 190, current loss = 414832.4
Iter 191, current loss = 414832.4
Iter 192, current loss = 414832.4
Iter 193, current loss = 414832.4
Iter 194, current loss = 414832.4
Iter 195, current loss = 414832.4
Iter 196, current loss = 414832.4
Iter 197, current loss = 414832.4
Iter 198, current loss = 414832.4
Iter 199, current loss = 414832.4
Iter 200, current loss = 414832.4
Iter 201, current loss = 414832.4
Iter 202, current loss = 414832.4
Iter 203, current loss = 414832.4
Iter 204, current loss = 414832.4
Iter 205, current loss = 414832.4
Iter 206, current loss = 414832.4
Iter 207, current loss = 414832.4
Iter 208, current loss = 414832.4
Iter 209, current loss = 414832.4
Iter 210, current loss = 414832.4
Iter 211, current loss = 414832.4
Iter 212, current loss = 414832.4
Iter 213, current loss = 414832.4
Iter 214, current loss = 414832.4
Iter 215, current loss = 414832.4
Iter 216, current loss = 414832.4
Iter 217, current loss = 414832.4
Iter 218, current loss = 414832.4
Iter 219, current loss = 414832.4
Iter 220, current loss = 414832.4
Iter 221, current loss = 414832.4
Iter 222, current loss = 414832.4
Iter 223, current loss = 414832.4
Iter 224, current loss = 414832.4
Iter 225, current loss = 414832.4
Iter 226, current loss = 414832.4
Iter 227, current loss = 414832.4
Iter 228, current loss = 414832.4
Iter 229, current loss = 414832.4
Iter 230, current loss = 414832.4
Iter 231, current loss = 414832.4
Iter 232, current loss = 414832.4
Iter 233, current loss = 414832.4
Iter 234, current loss = 414832.4
Iter 235, current loss = 414832.4
Iter 236, current loss = 414832.4
Iter 237, current loss = 414832.4
Iter 238, current loss = 414832.4
Iter 239, current loss = 414832.4
Iter 240, current loss = 414832.4
Iter 241, current loss = 414832.4
Iter 242, current loss = 414832.4
Iter 243, current loss = 414832.4
Iter 244, current loss = 414832.4
Iter 245, current loss = 414832.4
Iter 246, current loss = 414832.4
Iter 247, current loss = 414832.4
Iter 248, current loss = 414832.4
Iter 249, current loss = 414832.4
Iter 250, current loss = 414832.4
Iter 251, current loss = 414832.4
Iter 252, current loss = 414832.4
Iter 253, current loss = 414832.4
Iter 254, current loss = 414832.4
Iter 255, current loss = 414832.4
Iter 256, current loss = 414832.4
Iter 257, current loss = 414832.4
Iter 258, current loss = 414832.4
Iter 259, current loss = 414832.4
Iter 260, current loss = 414832.4
Iter 261, current loss = 414832.4
Iter 262, current loss = 414832.4
Iter 263, current loss = 414832.4
Iter 264, current loss = 414832.4
Iter 265, current loss = 414832.4
Iter 266, current loss = 414832.4
Iter 267, current loss = 414832.4
Iter 268, current loss = 414832.4
Iter 269, current loss = 414832.4
Iter 270, current loss = 414832.4
Iter 271, current loss = 414832.4
Iter 272, current loss = 414832.4
Iter 273, current loss = 414832.4
Iter 274, current loss = 414832.4
Iter 275, current loss = 414832.4
Iter 276, current loss = 414832.4
Iter 277, current loss = 414832.4
Iter 278, current loss = 414832.4
Iter 279, current loss = 414832.4
Iter 280, current loss = 414832.4
Iter 281, current loss = 414832.4
Iter 282, current loss = 414832.4
Iter 283, current loss = 414832.4
Iter 284, current loss = 414832.4
Iter 285, current loss = 414832.4
Iter 286, current loss = 414832.4
Iter 287, current loss = 414832.4
Iter 288, current loss = 414832.4
Iter 289, current loss = 414649.0
Iter 290, current loss = 414649.0
Iter 291, current loss = 414649.0
Iter 292, current loss = 414649.0
Iter 293, current loss = 414649.0
Iter 294, current loss = 414649.0
Iter 295, current loss = 414649.0
Iter 296, current loss = 414649.0
Iter 297, current loss = 414649.0
Iter 298, current loss = 414649.0
Iter 299, current loss = 414649.0
Iter 300, current loss = 414649.0
Iter 301, current loss = 414649.0
Iter 302, current loss = 414649.0
Iter 303, current loss = 414649.0
Iter 304, current loss = 414649.0
Iter 305, current loss = 414649.0
Iter 306, current loss = 414649.0
Iter 307, current loss = 414180.4
Iter 308, current loss = 414180.4
Iter 309, current loss = 414180.4
Iter 310, current loss = 414180.4
Iter 311, current loss = 414180.4
Iter 312, current loss = 414180.4
Iter 313, current loss = 414180.4
Iter 314, current loss = 414180.4
Iter 315, current loss = 414180.4
Iter 316, current loss = 414180.4
Iter 317, current loss = 414180.4
Iter 318, current loss = 414180.4
Iter 319, current loss = 414180.4
Iter 320, current loss = 414180.4
Iter 321, current loss = 414180.4
Iter 322, current loss = 414180.4
Iter 323, current loss = 414180.4
Iter 324, current loss = 414180.4
Iter 325, current loss = 414180.4
Iter 326, current loss = 414180.4
Iter 327, current loss = 414180.4
Iter 328, current loss = 414180.4
Iter 329, current loss = 414180.4
Iter 330, current loss = 414180.4
Iter 331, current loss = 414180.4
Iter 332, current loss = 414180.4
Iter 333, current loss = 414180.4
Iter 334, current loss = 414180.4
Iter 335, current loss = 414180.4
Iter 336, current loss = 414180.4
Iter 337, current loss = 414180.4
Iter 338, current loss = 413211.5
Iter 339, current loss = 413211.5
Iter 340, current loss = 413211.5
Iter 341, current loss = 413211.5
Iter 342, current loss = 413211.5
Iter 343, current loss = 413211.5
Iter 344, current loss = 413211.5
Iter 345, current loss = 413211.5
Iter 346, current loss = 413211.5
Iter 347, current loss = 413211.5
Iter 348, current loss = 413211.5
Iter 349, current loss = 413211.5
Iter 350, current loss = 413211.5
Iter 351, current loss = 413211.5
Iter 352, current loss = 413211.5
Iter 353, current loss = 413211.5
Iter 354, current loss = 413211.5
Iter 355, current loss = 413211.5
Iter 356, current loss = 413211.5
Iter 357, current loss = 413211.5
Iter 358, current loss = 413211.5
Iter 359, current loss = 413211.5
Iter 360, current loss = 413211.5
Iter 361, current loss = 413211.5
Iter 362, current loss = 413211.5
Iter 363, current loss = 413211.5
Iter 364, current loss = 413211.5
Iter 365, current loss = 413211.5
Iter 366, current loss = 413211.5
Iter 367, current loss = 413211.5
Iter 368, current loss = 412006.9
Iter 369, current loss = 412006.9
Iter 370, current loss = 412006.9
Iter 371, current loss = 412006.9
Iter 372, current loss = 412006.9
Iter 373, current loss = 412006.9
Iter 374, current loss = 412006.9
Iter 375, current loss = 412006.9
Iter 376, current loss = 412006.9
Iter 377, current loss = 412006.9
Iter 378, current loss = 412006.9
Iter 379, current loss = 412006.9
Iter 380, current loss = 412006.9
Iter 381, current loss = 412006.9
Iter 382, current loss = 412006.9
Iter 383, current loss = 412006.9
Iter 384, current loss = 412006.9
Iter 385, current loss = 412006.9
Iter 386, current loss = 412006.9
Iter 387, current loss = 412006.9
Iter 388, current loss = 412006.9
Iter 389, current loss = 412006.9
Iter 390, current loss = 412006.9
Iter 391, current loss = 412006.9
Iter 392, current loss = 412006.9
Iter 393, current loss = 412006.9
Iter 394, current loss = 412006.9
Iter 395, current loss = 412006.9
Iter 396, current loss = 412006.9
Iter 397, current loss = 412006.9
Iter 398, current loss = 412006.9
Iter 399, current loss = 412006.9
Iter 400, current loss = 412006.9
Iter 401, current loss = 412006.9
Iter 402, current loss = 412006.9
Iter 403, current loss = 412006.9
Iter 404, current loss = 412006.9
Iter 405, current loss = 412006.9
Iter 406, current loss = 412006.9
Iter 407, current loss = 412006.9
Iter 408, current loss = 412006.9
Iter 409, current loss = 412006.9
Iter 410, current loss = 412006.9
Iter 411, current loss = 412006.9
Iter 412, current loss = 409300.3
Iter 413, current loss = 409300.3
Iter 414, current loss = 409300.3
Iter 415, current loss = 409300.3
Iter 416, current loss = 409300.3
Iter 417, current loss = 409300.3
Iter 418, current loss = 409300.3
Iter 419, current loss = 409300.3
Iter 420, current loss = 409300.3
Iter 421, current loss = 409300.3
Iter 422, current loss = 409300.3
Iter 423, current loss = 409300.3
Iter 424, current loss = 409300.3
Iter 425, current loss = 409300.3
Iter 426, current loss = 409300.3
Iter 427, current loss = 409300.3
Iter 428, current loss = 409300.3
Iter 429, current loss = 409300.3
Iter 430, current loss = 409300.3
Iter 431, current loss = 409300.3
Iter 432, current loss = 409300.3
Iter 433, current loss = 409300.3
Iter 434, current loss = 409300.3
Iter 435, current loss = 409300.3
Iter 436, current loss = 409300.3
Iter 437, current loss = 409300.3
Iter 438, current loss = 409300.3
Iter 439, current loss = 409300.3
Iter 440, current loss = 409300.3
Iter 441, current loss = 409300.3
Iter 442, current loss = 409300.3
Iter 443, current loss = 409300.3
Iter 444, current loss = 409300.3
Iter 445, current loss = 409300.3
Iter 446, current loss = 409300.3
Iter 447, current loss = 409300.3
Iter 448, current loss = 409300.3
Iter 449, current loss = 409300.3
Iter 450, current loss = 409300.3
Iter 451, current loss = 409300.3
Iter 452, current loss = 409300.3
Iter 453, current loss = 409300.3
Iter 454, current loss = 409300.3
Iter 455, current loss = 409300.3
Iter 456, current loss = 409300.3
Iter 457, current loss = 409300.3
Iter 458, current loss = 409300.3
Iter 459, current loss = 409300.3
Iter 460, current loss = 409300.3
Iter 461, current loss = 409300.3
Iter 462, current loss = 409300.3
Iter 463, current loss = 409300.3
Iter 464, current loss = 409300.3
Iter 465, current loss = 409300.3
Iter 466, current loss = 409300.3
Iter 467, current loss = 409300.3
Iter 468, current loss = 409300.3
Iter 469, current loss = 409300.3
Iter 470, current loss = 409300.3
Iter 471, current loss = 409300.3
Iter 472, current loss = 409300.3
Iter 473, current loss = 409300.3
Iter 474, current loss = 409300.3
Iter 475, current loss = 409300.3
Iter 476, current loss = 409300.3
Iter 477, current loss = 409300.3
Iter 478, current loss = 409300.3
Iter 479, current loss = 409300.3
Iter 480, current loss = 409300.3
Iter 481, current loss = 409300.3
Iter 482, current loss = 409300.3
Iter 483, current loss = 409300.3
Iter 484, current loss = 409300.3
Iter 485, current loss = 409300.3
Iter 486, current loss = 409300.3
Iter 487, current loss = 409300.3
Iter 488, current loss = 409300.3
Iter 489, current loss = 409300.3
Iter 490, current loss = 409300.3
Iter 491, current loss = 409300.3
Iter 492, current loss = 409300.3
Iter 493, current loss = 409300.3
Iter 494, current loss = 409300.3
Iter 495, current loss = 409300.3
Iter 496, current loss = 409300.3
Iter 497, current loss = 409300.3
Iter 498, current loss = 409300.3
Iter 499, current loss = 409300.3
Iter 500, current loss = 409300.3
Iter 501, current loss = 409300.3
Iter 502, current loss = 409300.3
Iter 503, current loss = 409300.3
Iter 504, current loss = 409300.3
Iter 505, current loss = 409300.3
Iter 506, current loss = 409300.3
Iter 507, current loss = 409300.3
Iter 508, current loss = 409300.3
Iter 509, current loss = 409300.3
Iter 510, current loss = 409300.3
Iter 511, current loss = 409300.3
Iter 512, current loss = 409300.3
Iter 513, current loss = 409300.3
Iter 514, current loss = 409300.3
Iter 515, current loss = 409300.3
Iter 516, current loss = 409300.3
Iter 517, current loss = 409300.3
Iter 518, current loss = 409300.3
Iter 519, current loss = 409300.3
Iter 520, current loss = 409300.3
Iter 521, current loss = 409300.3
Iter 522, current loss = 409300.3
Iter 523, current loss = 409300.3
Iter 524, current loss = 409300.3
Iter 525, current loss = 409300.3
Iter 526, current loss = 409300.3
Iter 527, current loss = 409300.3
Iter 528, current loss = 409300.3
Iter 529, current loss = 409300.3
Iter 530, current loss = 409300.3
Iter 531, current loss = 409300.3
Iter 532, current loss = 409300.3
Iter 533, current loss = 409300.3
Iter 534, current loss = 409300.3
Iter 535, current loss = 409300.3
Iter 536, current loss = 409300.3
Iter 537, current loss = 409300.3
Iter 538, current loss = 409300.3
Iter 539, current loss = 409300.3
Iter 540, current loss = 409300.3
Iter 541, current loss = 409300.3
Iter 542, current loss = 409300.3
Iter 543, current loss = 409300.3
Iter 544, current loss = 409300.3
Iter 545, current loss = 409300.3
Iter 546, current loss = 409300.3
Iter 547, current loss = 409300.3
Iter 548, current loss = 409300.3
Iter 549, current loss = 409300.3
Iter 550, current loss = 409300.3
Iter 551, current loss = 409300.3
Iter 552, current loss = 409300.3
Iter 553, current loss = 409300.3
Iter 554, current loss = 409300.3
Iter 555, current loss = 409300.3
Iter 556, current loss = 409300.3
Iter 557, current loss = 409300.3
Iter 558, current loss = 409300.3
Iter 559, current loss = 409300.3
Iter 560, current loss = 409300.3
Iter 561, current loss = 409300.3
Iter 562, current loss = 409300.3
Iter 563, current loss = 409300.3
Iter 564, current loss = 409300.3
Iter 565, current loss = 409300.3
Iter 566, current loss = 409300.3
Iter 567, current loss = 409300.3
Iter 568, current loss = 409300.3
Iter 569, current loss = 409300.3
Iter 570, current loss = 409300.3
Iter 571, current loss = 409300.3
Iter 572, current loss = 409300.3
Iter 573, current loss = 409300.3
Iter 574, current loss = 409300.3
Iter 575, current loss = 409300.3
Iter 576, current loss = 409300.3
Iter 577, current loss = 409300.3
Iter 578, current loss = 409300.3
Iter 579, current loss = 409300.3
Iter 580, current loss = 409300.3
Iter 581, current loss = 409300.3
Iter 582, current loss = 409300.3
Iter 583, current loss = 409300.3
Iter 584, current loss = 409300.3
Iter 585, current loss = 409300.3
Iter 586, current loss = 409300.3
Iter 587, current loss = 409300.3
Iter 588, current loss = 409300.3
Iter 589, current loss = 409300.3
Iter 590, current loss = 409300.3
Iter 591, current loss = 409300.3
Iter 592, current loss = 409300.3
Iter 593, current loss = 409300.3
Iter 594, current loss = 409300.3
Iter 595, current loss = 409300.3
Iter 596, current loss = 409300.3
Iter 597, current loss = 409300.3
Iter 598, current loss = 409300.3
Iter 599, current loss = 409300.3
Iter 600, current loss = 409300.3
Iter 601, current loss = 409300.3
Iter 602, current loss = 409300.3
Iter 603, current loss = 409300.3
Iter 604, current loss = 409300.3
Iter 605, current loss = 409300.3
Iter 606, current loss = 409300.3
Iter 607, current loss = 409300.3
Iter 608, current loss = 409300.3
Iter 609, current loss = 409300.3
Iter 610, current loss = 409300.3
Iter 611, current loss = 409300.3
Iter 612, current loss = 409300.3
Iter 613, current loss = 409300.3
Iter 614, current loss = 409300.3
Iter 615, current loss = 409300.3
Iter 616, current loss = 409300.3
Iter 617, current loss = 409300.3
Iter 618, current loss = 409300.3
Iter 619, current loss = 409300.3
Iter 620, current loss = 409300.3
Iter 621, current loss = 409300.3
Iter 622, current loss = 409300.3
Iter 623, current loss = 409300.3
Iter 624, current loss = 409300.3
Iter 625, current loss = 409300.3
Iter 626, current loss = 409300.3
Iter 627, current loss = 409300.3
Iter 628, current loss = 409300.3
Iter 629, current loss = 409300.3
Iter 630, current loss = 409300.3
Iter 631, current loss = 409300.3
Iter 632, current loss = 409300.3
Iter 633, current loss = 409300.3
Iter 634, current loss = 409300.3
Iter 635, current loss = 409300.3
Iter 636, current loss = 409300.3
Iter 637, current loss = 409300.3
Iter 638, current loss = 409300.3
Iter 639, current loss = 409300.3
Iter 640, current loss = 409300.3
Iter 641, current loss = 409300.3
Iter 642, current loss = 409300.3
Iter 643, current loss = 409300.3
Iter 644, current loss = 409300.3
Iter 645, current loss = 409300.3
Iter 646, current loss = 409300.3
Iter 647, current loss = 409300.3
Iter 648, current loss = 409300.3
Iter 649, current loss = 409300.3
Iter 650, current loss = 409300.3
Iter 651, current loss = 409300.3
Iter 652, current loss = 409300.3
Iter 653, current loss = 409300.3
Iter 654, current loss = 409300.3
Iter 655, current loss = 409300.3
Iter 656, current loss = 409300.3
Iter 657, current loss = 409300.3
Iter 658, current loss = 409300.3
Iter 659, current loss = 409300.3
Iter 660, current loss = 409300.3
Iter 661, current loss = 409300.3
Iter 662, current loss = 409300.3
Iter 663, current loss = 409300.3
Iter 664, current loss = 409300.3
Iter 665, current loss = 409300.3
Iter 666, current loss = 409300.3
Iter 667, current loss = 409300.3
Iter 668, current loss = 409300.3
Iter 669, current loss = 409300.3
Iter 670, current loss = 409300.3
Iter 671, current loss = 409300.3
Iter 672, current loss = 409300.3
Iter 673, current loss = 409300.3
Iter 674, current loss = 409300.3
Iter 675, current loss = 409300.3
Iter 676, current loss = 409300.3
Iter 677, current loss = 409300.3
Iter 678, current loss = 409300.3
Iter 679, current loss = 409300.3
Iter 680, current loss = 409300.3
Iter 681, current loss = 409300.3
Iter 682, current loss = 409300.3
Iter 683, current loss = 409300.3
Iter 684, current loss = 409300.3
Iter 685, current loss = 409300.3
Iter 686, current loss = 409300.3
Iter 687, current loss = 409300.3
Iter 688, current loss = 409300.3
Iter 689, current loss = 409300.3
Iter 690, current loss = 409300.3
Iter 691, current loss = 409300.3
Iter 692, current loss = 409300.3
Iter 693, current loss = 409300.3
Iter 694, current loss = 409300.3
Iter 695, current loss = 409300.3
Iter 696, current loss = 409300.3
Iter 697, current loss = 409300.3
Iter 698, current loss = 409300.3
Iter 699, current loss = 409300.3
Iter 700, current loss = 409300.3
Iter 701, current loss = 409300.3
Iter 702, current loss = 409300.3
Iter 703, current loss = 409300.3
Iter 704, current loss = 409300.3
Iter 705, current loss = 409300.3
Iter 706, current loss = 409300.3
Iter 707, current loss = 409300.3
Iter 708, current loss = 409300.3
Iter 709, current loss = 409300.3
Iter 710, current loss = 409300.3
Iter 711, current loss = 409300.3
Iter 712, current loss = 409300.3
Iter 713, current loss = 409300.3
Iter 714, current loss = 409300.3
Iter 715, current loss = 409300.3
Iter 716, current loss = 409300.3
Iter 717, current loss = 409300.3
Iter 718, current loss = 409300.3
Iter 719, current loss = 409300.3
Iter 720, current loss = 409300.3
Iter 721, current loss = 409300.3
Iter 722, current loss = 409300.3
Iter 723, current loss = 409300.3
Iter 724, current loss = 409300.3
Iter 725, current loss = 409300.3
Iter 726, current loss = 409300.3
Iter 727, current loss = 409300.3
Iter 728, current loss = 409300.3
Iter 729, current loss = 409300.3
Iter 730, current loss = 409300.3
Iter 731, current loss = 409300.3
Iter 732, current loss = 409300.3
Iter 733, current loss = 409300.3
Iter 734, current loss = 409300.3
Iter 735, current loss = 409300.3
Iter 736, current loss = 409300.3
Iter 737, current loss = 409300.3
Iter 738, current loss = 409300.3
Iter 739, current loss = 409300.3
Iter 740, current loss = 409300.3
Iter 741, current loss = 409300.3
Iter 742, current loss = 409300.3
Iter 743, current loss = 409300.3
Iter 744, current loss = 409300.3
Iter 745, current loss = 409300.3
Iter 746, current loss = 409300.3
Iter 747, current loss = 409300.3
Iter 748, current loss = 409300.3
Iter 749, current loss = 409300.3
Iter 750, current loss = 409300.3
Iter 751, current loss = 409300.3
Iter 752, current loss = 409300.3
Iter 753, current loss = 409300.3
Iter 754, current loss = 409300.3
Iter 755, current loss = 409300.3
Iter 756, current loss = 409300.3
Iter 757, current loss = 409300.3
Iter 758, current loss = 409300.3
Iter 759, current loss = 409300.3
Iter 760, current loss = 409300.3
Iter 761, current loss = 409300.3
Iter 762, current loss = 409300.3
Iter 763, current loss = 409300.3
Iter 764, current loss = 409300.3
Iter 765, current loss = 409300.3
Iter 766, current loss = 409300.3
Iter 767, current loss = 409300.3
Iter 768, current loss = 409300.3
Iter 769, current loss = 409300.3
Iter 770, current loss = 409300.3
Iter 771, current loss = 409300.3
Iter 772, current loss = 409300.3
Iter 773, current loss = 409300.3
Iter 774, current loss = 409300.3
Iter 775, current loss = 408832.5
Iter 776, current loss = 408832.5
Iter 777, current loss = 408832.5
Iter 778, current loss = 408832.5
Iter 779, current loss = 408832.5
Iter 780, current loss = 408832.5
Iter 781, current loss = 408832.5
Iter 782, current loss = 408832.5
Iter 783, current loss = 408832.5
Iter 784, current loss = 408832.5
Iter 785, current loss = 408832.5
Iter 786, current loss = 408832.5
Iter 787, current loss = 408832.5
Iter 788, current loss = 408832.5
Iter 789, current loss = 408832.5
Iter 790, current loss = 408832.5
Iter 791, current loss = 408832.5
Iter 792, current loss = 408832.5
Iter 793, current loss = 408832.5
Iter 794, current loss = 408832.5
Iter 795, current loss = 406891.5
Iter 796, current loss = 406891.5
Iter 797, current loss = 406891.5
Iter 798, current loss = 406891.5
Iter 799, current loss = 406891.5
Iter 800, current loss = 406891.5
Iter 801, current loss = 406891.5
Iter 802, current loss = 406891.5
Iter 803, current loss = 406891.5
Iter 804, current loss = 406891.5
Iter 805, current loss = 406891.5
Iter 806, current loss = 406891.5
Iter 807, current loss = 406891.5
Iter 808, current loss = 406891.5
Iter 809, current loss = 406891.5
Iter 810, current loss = 406891.5
Iter 811, current loss = 406891.5
Iter 812, current loss = 406891.5
Iter 813, current loss = 406891.5
Iter 814, current loss = 406891.5
Iter 815, current loss = 406891.5
Iter 816, current loss = 406891.5
Iter 817, current loss = 406891.5
Iter 818, current loss = 406891.5
Iter 819, current loss = 406891.5
Iter 820, current loss = 406891.5
Iter 821, current loss = 406891.5
Iter 822, current loss = 406891.5
Iter 823, current loss = 406891.5
Iter 824, current loss = 406891.5
Iter 825, current loss = 406891.5
Iter 826, current loss = 406891.5
Iter 827, current loss = 406891.5
Iter 828, current loss = 406891.5
Iter 829, current loss = 406891.5
Iter 830, current loss = 406891.5
Iter 831, current loss = 406891.5
Iter 832, current loss = 406891.5
Iter 833, current loss = 406891.5
Iter 834, current loss = 406891.5
Iter 835, current loss = 406891.5
Iter 836, current loss = 406891.5
Iter 837, current loss = 406891.5
Iter 838, current loss = 406891.5
Iter 839, current loss = 406891.5
Iter 840, current loss = 406891.5
Iter 841, current loss = 406891.5
Iter 842, current loss = 406891.5
Iter 843, current loss = 406891.5
Iter 844, current loss = 406891.5
Iter 845, current loss = 406891.5
Iter 846, current loss = 406891.5
Iter 847, current loss = 406891.5
Iter 848, current loss = 406891.5
Iter 849, current loss = 406891.5
Iter 850, current loss = 406891.5
Iter 851, current loss = 406891.5
Iter 852, current loss = 406891.5
Iter 853, current loss = 406891.5
Iter 854, current loss = 406891.5
Iter 855, current loss = 406891.5
Iter 856, current loss = 406891.5
Iter 857, current loss = 406891.5
Iter 858, current loss = 406891.5
Iter 859, current loss = 406891.5
Iter 860, current loss = 406891.5
Iter 861, current loss = 406891.5
Iter 862, current loss = 406891.5
Iter 863, current loss = 406891.5
Iter 864, current loss = 406891.5
Iter 865, current loss = 406891.5
Iter 866, current loss = 406891.5
Iter 867, current loss = 406891.5
Iter 868, current loss = 406891.5
Iter 869, current loss = 406891.5
Iter 870, current loss = 406891.5
Iter 871, current loss = 406891.5
Iter 872, current loss = 406891.5
Iter 873, current loss = 406891.5
Iter 874, current loss = 406891.5
Iter 875, current loss = 406891.5
Iter 876, current loss = 406891.5
Iter 877, current loss = 406891.5
Iter 878, current loss = 406891.5
Iter 879, current loss = 406891.5
Iter 880, current loss = 406891.5
Iter 881, current loss = 406891.5
Iter 882, current loss = 406891.5
Iter 883, current loss = 406891.5
Iter 884, current loss = 406891.5
Iter 885, current loss = 406891.5
Iter 886, current loss = 406891.5
Iter 887, current loss = 406891.5
Iter 888, current loss = 406891.5
Iter 889, current loss = 406891.5
Iter 890, current loss = 406891.5
Iter 891, current loss = 406891.5
Iter 892, current loss = 406891.5
Iter 893, current loss = 406891.5
Iter 894, current loss = 406891.5
Iter 895, current loss = 406891.5
Iter 896, current loss = 406891.5
Iter 897, current loss = 406891.5
Iter 898, current loss = 406891.5
Iter 899, current loss = 406891.5
Iter 900, current loss = 406891.5
Iter 901, current loss = 406891.5
Iter 902, current loss = 406891.5
Iter 903, current loss = 406891.5
Iter 904, current loss = 406891.5
Iter 905, current loss = 406891.5
Iter 906, current loss = 406891.5
Iter 907, current loss = 406891.5
Iter 908, current loss = 406891.5
Iter 909, current loss = 406891.5
Iter 910, current loss = 406891.5
Iter 911, current loss = 406891.5
Iter 912, current loss = 406891.5
Iter 913, current loss = 406891.5
Iter 914, current loss = 406891.5
Iter 915, current loss = 406891.5
Iter 916, current loss = 406891.5
Iter 917, current loss = 406891.5
Iter 918, current loss = 406891.5
Iter 919, current loss = 406891.5
Iter 920, current loss = 406891.5
Iter 921, current loss = 406891.5
Iter 922, current loss = 406891.5
Iter 923, current loss = 406891.5
Iter 924, current loss = 406891.5
Iter 925, current loss = 406891.5
Iter 926, current loss = 406891.5
Iter 927, current loss = 406891.5
Iter 928, current loss = 406891.5
Iter 929, current loss = 406891.5
Iter 930, current loss = 406891.5
Iter 931, current loss = 406891.5
Iter 932, current loss = 406891.5
Iter 933, current loss = 406891.5
Iter 934, current loss = 406891.5
Iter 935, current loss = 406891.5
Iter 936, current loss = 406891.5
Iter 937, current loss = 406891.5
Iter 938, current loss = 406891.5
Iter 939, current loss = 406891.5
Iter 940, current loss = 406891.5
Iter 941, current loss = 406891.5
Iter 942, current loss = 406891.5
Iter 943, current loss = 406891.5
Iter 944, current loss = 406891.5
Iter 945, current loss = 406891.5
Iter 946, current loss = 406891.5
Iter 947, current loss = 406891.5
Iter 948, current loss = 406891.5
Iter 949, current loss = 406891.5
Iter 950, current loss = 406891.5
Iter 951, current loss = 406891.5
Iter 952, current loss = 406891.5
Iter 953, current loss = 406891.5
Iter 954, current loss = 406891.5
Iter 955, current loss = 406891.5
Iter 956, current loss = 406891.5
Iter 957, current loss = 406891.5
Iter 958, current loss = 406891.5
Iter 959, current loss = 406891.5
Iter 960, current loss = 406891.5
Iter 961, current loss = 406891.5
Iter 962, current loss = 406891.5
Iter 963, current loss = 406891.5
Iter 964, current loss = 406891.5
Iter 965, current loss = 406891.5
Iter 966, current loss = 406891.5
Iter 967, current loss = 406891.5
Iter 968, current loss = 406891.5
Iter 969, current loss = 406891.5
Iter 970, current loss = 406891.5
Iter 971, current loss = 406891.5
Iter 972, current loss = 406891.5
Iter 973, current loss = 406891.5
Iter 974, current loss = 406891.5
Iter 975, current loss = 406891.5
Iter 976, current loss = 406891.5
Iter 977, current loss = 406891.5
Iter 978, current loss = 406891.5
Iter 979, current loss = 406891.5
Iter 980, current loss = 406891.5
Iter 981, current loss = 406891.5
Iter 982, current loss = 406891.5
Iter 983, current loss = 406891.5
Iter 984, current loss = 406891.5
Iter 985, current loss = 406891.5
Iter 986, current loss = 406891.5
Iter 987, current loss = 406891.5
Iter 988, current loss = 406891.5
Iter 989, current loss = 406891.5
Iter 990, current loss = 406891.5
Iter 991, current loss = 406891.5
Iter 992, current loss = 406891.5
Iter 993, current loss = 406891.5
Iter 994, current loss = 406891.5
Iter 995, current loss = 406891.5
Iter 996, current loss = 406891.5
Iter 997, current loss = 406891.5
Iter 998, current loss = 406891.5
Iter 999, current loss = 406891.5
Iter 1000, current loss = 406891.5
Iter 1001, current loss = 406891.5
Iter 1002, current loss = 406891.5
Iter 1003, current loss = 406891.5
Iter 1004, current loss = 406891.5
Iter 1005, current loss = 406891.5
Iter 1006, current loss = 406891.5
Iter 1007, current loss = 406891.5
Iter 1008, current loss = 406891.5
Iter 1009, current loss = 406891.5
Iter 1010, current loss = 406891.5
Iter 1011, current loss = 406891.5
Iter 1012, current loss = 406891.5
Iter 1013, current loss = 406891.5
Iter 1014, current loss = 406891.5
Iter 1015, current loss = 406891.5
Iter 1016, current loss = 406891.5
Iter 1017, current loss = 406891.5
Iter 1018, current loss = 406891.5
Iter 1019, current loss = 406891.5
Iter 1020, current loss = 406891.5
Iter 1021, current loss = 406891.5
Iter 1022, current loss = 406891.5
Iter 1023, current loss = 406891.5
Iter 1024, current loss = 406891.5
Iter 1025, current loss = 406891.5
Iter 1026, current loss = 406891.5
Iter 1027, current loss = 406891.5
Iter 1028, current loss = 406891.5
Iter 1029, current loss = 406891.5
Iter 1030, current loss = 406891.5
Iter 1031, current loss = 406891.5
Iter 1032, current loss = 406891.5
Iter 1033, current loss = 406891.5
Iter 1034, current loss = 406891.5
Iter 1035, current loss = 406891.5
Iter 1036, current loss = 406891.5
Iter 1037, current loss = 406891.5
Iter 1038, current loss = 406891.5
Iter 1039, current loss = 406891.5
Iter 1040, current loss = 406891.5
Iter 1041, current loss = 406891.5
Iter 1042, current loss = 406891.5
Iter 1043, current loss = 406891.5
Iter 1044, current loss = 406891.5
Iter 1045, current loss = 406891.5
Iter 1046, current loss = 406891.5
Iter 1047, current loss = 406891.5
Iter 1048, current loss = 406891.5
Iter 1049, current loss = 406891.5
Iter 1050, current loss = 406891.5
Iter 1051, current loss = 406891.5
Iter 1052, current loss = 406891.5
Iter 1053, current loss = 406891.5
Iter 1054, current loss = 406891.5
Iter 1055, current loss = 406891.5
Iter 1056, current loss = 406891.5
Iter 1057, current loss = 406891.5
Iter 1058, current loss = 406891.5
Iter 1059, current loss = 406891.5
Iter 1060, current loss = 406891.5
Iter 1061, current loss = 406891.5
Iter 1062, current loss = 406891.5
Iter 1063, current loss = 406891.5
Iter 1064, current loss = 406891.5
Iter 1065, current loss = 406891.5
Iter 1066, current loss = 406891.5
Iter 1067, current loss = 406891.5
Iter 1068, current loss = 406891.5
Iter 1069, current loss = 406891.5
Iter 1070, current loss = 406891.5
Iter 1071, current loss = 406891.5
Iter 1072, current loss = 406891.5
Iter 1073, current loss = 406891.5
Iter 1074, current loss = 406891.5
Iter 1075, current loss = 406891.5
Iter 1076, current loss = 406891.5
Iter 1077, current loss = 406891.5
Iter 1078, current loss = 406891.5
Iter 1079, current loss = 406891.5
Iter 1080, current loss = 406891.5
Iter 1081, current loss = 406891.5
Iter 1082, current loss = 406891.5
Iter 1083, current loss = 406891.5
Iter 1084, current loss = 406891.5
Iter 1085, current loss = 406891.5
Iter 1086, current loss = 406891.5
Iter 1087, current loss = 406891.5
Iter 1088, current loss = 406891.5
Iter 1089, current loss = 406891.5
Iter 1090, current loss = 406891.5
Iter 1091, current loss = 406891.5
Iter 1092, current loss = 406891.5
Iter 1093, current loss = 406891.5
Iter 1094, current loss = 406891.5
Iter 1095, current loss = 406891.5
Iter 1096, current loss = 406891.5
Iter 1097, current loss = 406891.5
Iter 1098, current loss = 406891.5
Iter 1099, current loss = 406891.5
Iter 1100, current loss = 406891.5
Iter 1101, current loss = 406891.5
Iter 1102, current loss = 406891.5
Iter 1103, current loss = 406891.5
Iter 1104, current loss = 406891.5
Iter 1105, current loss = 406891.5
Iter 1106, current loss = 406891.5
Iter 1107, current loss = 406891.5
Iter 1108, current loss = 406891.5
Iter 1109, current loss = 406891.5
Iter 1110, current loss = 406891.5
Iter 1111, current loss = 406891.5
Iter 1112, current loss = 406891.5
Iter 1113, current loss = 406891.5
Iter 1114, current loss = 406891.5
Iter 1115, current loss = 406891.5
Iter 1116, current loss = 406891.5
Iter 1117, current loss = 406891.5
Iter 1118, current loss = 406891.5
Iter 1119, current loss = 406891.5
Iter 1120, current loss = 406891.5
Iter 1121, current loss = 406891.5
Iter 1122, current loss = 406891.5
Iter 1123, current loss = 406891.5
Iter 1124, current loss = 406891.5
Iter 1125, current loss = 406891.5
Iter 1126, current loss = 406891.5
Iter 1127, current loss = 406891.5
Iter 1128, current loss = 406891.5
Iter 1129, current loss = 406891.5
Iter 1130, current loss = 406891.5
Iter 1131, current loss = 406891.5
Iter 1132, current loss = 406891.5
Iter 1133, current loss = 406891.5
Iter 1134, current loss = 406891.5
"""